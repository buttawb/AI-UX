<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI UX Tester</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #heatmapContainer {
        width: 500px;
        height: 500px;
        position: relative;
        border: 1px solid #ccc;
      }
      .file-selection {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>AI UX Tester</h1>

    <!-- Select Figma File (this is hardcoded for now) -->
    <div class="file-selection">
      <label for="figmaFileSelect">Figma File: </label>
      <span>Document-Upload-Scenarios</span>
      <!-- This is hardcoded for now -->
    </div>

    <!-- Submit Button -->
    <button id="submitBtn">Submit for Analysis</button>

    <!-- Display Heatmap -->
    <h2>Analyzing design: <span id="designName">ShopUnion</span></h2>

    <div style="display:flex; gap: 20px;">
      <!-- Left: Design + Heatmap container -->
      <div id="heatmapContainer" style="position: relative; width: 600px; height: 600px; border: 1px solid #ccc;">
        <img id="figmaImage" src="" alt="Figma Design" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 0;">
        <div id="heatmapLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
      </div>
    
      <!-- Right: UX Report -->
      <div id="uxReport" style="width: 400px; max-height: 600px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; white-space: pre-wrap;"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

    <script>
      const FIGMA_FILE_ID = 'yS1jm9l3wX3ie4RwAJA01V'; // your file ID
      
      // Step 1: Fetch image URL from backend and set it
      function loadDesignImage() {
        return $.ajax({
          url: '/ux/fetch_figma_image_url/',
          type: 'GET',
        }).then(response => {
          if (response.image_url) {
            $('#figmaImage').attr('src', response.image_url);
          }
        });
      }
      
      // Step 2: Fetch design JSON (or skip if you already have it), send to AI, get heatmap + report
      function analyzeDesignWithAI(figmaData) {
        return $.ajax({
          url: '/ux/generate_heatmap/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ figma_data: figmaData }),
        });
      }
      
      // Step 3: Render heatmap on overlay div
      function renderHeatmap(data) {
        if (!data || !Array.isArray(data)) {
          console.error('Invalid heatmap data received:', data);
          return;
        }

        const container = document.getElementById('heatmapLayer');
        if (window.heatmapInstance) {
          window.heatmapInstance.setData({ max: 0, data: [] });
          container.innerHTML = '';
        }
        window.heatmapInstance = h337.create({
          container: container,
          radius: 40,
          maxOpacity: 0.6,
          minOpacity: 0,
          blur: 0.75,
        });
      
        // heatmap.js expects 'value' key instead of 'intensity'
        const formattedData = data.map(pt => ({
          x: pt.x,
          y: pt.y,
          value: pt.intensity ?? 1,
        }));
      
        window.heatmapInstance.setData({
          max: 1,
          data: formattedData,
        });
      }
      
      // Step 4: Show UX report text
      function showUXReport(reportText) {
        $('#uxReport').text(reportText);
      }
      
      // Main submit flow
      $('#submitBtn').click(async function () {
        try {
          // 1. Load Figma image
          await loadDesignImage();
      
          // 2. Fetch full design JSON from backend
          const figmaResponse = await $.ajax({
            url: '/ux/fetch_figma_file/',
            type: 'POST',
            data: { file_id: FIGMA_FILE_ID },
          });
      
          // 3. Send design JSON to AI for heatmap + report
          const aiResponse = await analyzeDesignWithAI(figmaResponse.document);
          
          // Log the response to debug
          console.log('AI Response:', aiResponse);
          
          if (!aiResponse || !aiResponse.heatmap_data || !aiResponse.heatmap_data.heatmap) {
            throw new Error('Invalid response from AI analysis');
          }
      
          // 4. Render heatmap
          renderHeatmap(aiResponse.heatmap_data.heatmap);
      
          // 5. Show detailed UX report
          showUXReport(aiResponse.heatmap_data.report);
      
          // 6. Show design name
          $('#designName').text(figmaResponse.name || 'Unknown Design');
        } catch (e) {
          console.error('Error:', e);
          alert('Failed to analyze design. Check console for details.');
        }
      });
    </script>
  </body>
</html>
