<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI UX Tester - Multi-Frame Analysis</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; }
        h1, h2 { color: #333; }
        #controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #submitBtn { background-color: #007bff; color: white; border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        #submitBtn:hover { background-color: #0056b3; }
        #submitBtn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #loader { display: none; text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .frame-container { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .frame-header { font-size: 1.5em; font-weight: bold; color: #1a1a1a; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .analysis-content { display: flex; flex-wrap: wrap; gap: 20px; }
        .design-column { flex: 2; min-width: 400px; }
        .report-column { flex: 1; min-width: 300px; }
        .heatmap-container { position: relative; border: 1px solid #ccc; background-color: #f0f0f0; display: inline-block; }
        .heatmap-container img { display: block; max-width: 100%; height: auto; }
        .heatmap-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .ux-report { background-color: #fdfdfd; border: 1px solid #e0e0e0; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto; border-radius: 5px; font-size: 14px; line-height: 1.6; }
        
        .ux-suggestion-marker { position: absolute; width: 24px; height: 24px; background: rgba(255, 26, 104, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; z-index: 10; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .ux-suggestion-marker:hover { transform: scale(1.2); box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    </style>
</head>
<body>
    <div id="controls">
        <h1>AI UX Tester</h1>
        <p>Click the button to fetch the pre-configured Figma file, analyze all its frames, and generate a UX report for each one.</p>
        <button id="submitBtn">Analyze Figma File</button>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <p>Analyzing... This may take a few minutes for large files.</p>
    </div>

    <div id="analysisContainer">
        </div>

    {% comment %} <script src="[https://code.jquery.com/jquery-3.7.1.min.js](https://code.jquery.com/jquery-3.7.1.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js](https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js)"></script> {% endcomment %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

    <script>
      $(document).ready(function() {
          const $submitBtn = $('#submitBtn');
          const $loader = $('#loader');
          const $analysisContainer = $('#analysisContainer');
  
          $submitBtn.on('click', async function() {
              $submitBtn.prop('disabled', true);
              $loader.show();
              $analysisContainer.empty().hide();
  
              try {
                  // 1. Fetch the entire Figma file structure
                  console.log("Fetching Figma file structure...");
                  const figmaFileResponse = await $.ajax({
                      url: '/ux/fetch_figma_file/',
                      type: 'GET'
                  });
                  console.log("Figma file fetched.", figmaFileResponse);
  
                  // 2. Extract all top-level frames from the document
                  const frames = [];
                  figmaFileResponse.document.children.forEach(canvas => {
                      if (canvas.children) {
                          canvas.children.forEach(frame => {
                              if (frame.type === 'FRAME') {
                                  frames.push({
                                      id: frame.id,
                                      name: frame.name,
                                      node: frame
                                  });
                              }
                          });
                      }
                  });
  
                  if (frames.length === 0) {
                      throw new Error("No frames found in the Figma file.");
                  }
                  console.log(`Found ${frames.length} frames to analyze.`);
                  const frameIds = frames.map(f => f.id);
  
                  // 3. Make parallel API calls
                  console.log("Fetching image URLs and running AI analysis in parallel...");
                  const [imageResponse, analysisResponse] = await Promise.all([
                      $.ajax({
                          url: '/ux/fetch_figma_image_urls/',
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify({ node_ids: frameIds }),
                      }),
                      $.ajax({
                          url: '/ux/generate_heatmap/',
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify({ figma_data: figmaFileResponse.document }),
                      })
                  ]);
                  const heatmapData = analysisResponse.heatmap_data;
                  // *** DEBUGGING & FIX: Add robust checks and clear logging ***
                  console.log("Raw image response from server:", imageResponse);
                  console.log("Raw analysis response from server:", heatmapData);
  
                  if (!imageResponse || !imageResponse.image_urls) {
                      throw new Error("The server response for images was invalid or missing the 'image_urls' key.");
                  }
                  const imageUrls = imageResponse.image_urls;
  
                  if (!heatmapData || !heatmapData.analysis_data) {
                      throw new Error("The server response for AI analysis was invalid or missing the 'analysis_data' key.");
                  }
                  const analysisData = heatmapData.analysis_data;
  
                  console.log("Data received and validated. Rendering results...");
                  $loader.hide();
  
                  // 4. Render results for each frame
                  frames.forEach(frame => {
                      const imageUrl = imageUrls[frame.id];
                      const frameAnalysis = analysisData[frame.id];
  
                      if (!imageUrl || !frameAnalysis) {
                          console.warn(`Skipping frame "${frame.name}" (${frame.id}) due to missing image URL or analysis data for this specific frame.`);
                          return; // Safely skip this frame
                      }
  
                      // Create the HTML structure for this frame
                      const frameHtml = `
                          <div class="frame-container" id="frame-container-${frame.id}">
                              <div class="frame-header">${frame.name}</div>
                              <div class="analysis-content">
                                  <div class="design-column">
                                      <div class="heatmap-container" id="heatmap-container-${frame.id}">
                                          <img id="image-${frame.id}" src="${imageUrl}" alt="Design for ${frame.name}" />
                                          <div class="heatmap-layer" id="heatmap-layer-${frame.id}"></div>
                                      </div>
                                  </div>
                                  <div class="report-column">
                                      <h2>UX/UI Report</h2>
                                      <div class="ux-report" id="report-${frame.id}">${frameAnalysis.report}</div>
                                  </div>
                              </div>
                          </div>
                      `;
                      $analysisContainer.append(frameHtml);
  
                      // Wait for the image to load before rendering heatmap/suggestions
                      // $(`#image-${frame.id}`).on('load', function() {
                          const $image = $(this);

                          renderHeatmap(frameAnalysis.heatmap, `heatmap-container-${frame.id}`);
                          renderSuggestions(frameAnalysis.suggestions, this, `heatmap-container-${frame.id}`);
                          $(`#report-${frame.id}`).text(frameAnalysis.report);
                      // }).each(function() {
                         // if (this.complete) $(this).trigger('load');
                      // });
                  });
                  
                  $analysisContainer.show();
  
              } catch (error) {
                  console.error('An error occurred during the analysis process:', error);
                  const errorMessage = error.responseJSON ? JSON.stringify(error.responseJSON.error) : error.message;
                  $loader.hide(); // Ensure loader is hidden on error
                  $analysisContainer.html(`<p style="color:red; text-align:center;"><strong>Analysis Failed:</strong> ${errorMessage}</p>`).show();
              } finally {
                  $submitBtn.prop('disabled', false);
              }
          });
  
          function renderHeatmap(data, containerId) {
              if (!data || !Array.isArray(data)) return;
              const container = document.getElementById(containerId);
              if (!container) return; // Add check for container existence

              console.log("FINAL RENDERING OF HEATMAP DATA:", data);
              const heatmapInstance = h337.create({ container: container, radius: 40, maxOpacity: 0.6, blur: 0.75 });
              const formattedData = data.map(pt => ({ x: pt.x, y: pt.y, value: pt.intensity ?? 1 }));
              console.log("IAM HEATMAP DATA:", formattedData);
              console.log("Heatmap instance created for container:", heatmapInstance);
              console.log("CONtainer ID", containerId);
              heatmapInstance.setData({ max: 1, data: formattedData });
          }
          
          function renderSuggestions(suggestions, imgElement, containerId) {
              if (!suggestions || !Array.isArray(suggestions)) return;
              const container = document.getElementById(containerId);
              if (!container) return; // Add check for container existence
              const imgNaturalWidth = imgElement.naturalWidth;
              const imgNaturalHeight = imgElement.naturalHeight;
  
              suggestions.forEach((s, idx) => {
                  const marker = document.createElement('div');
                  marker.className = 'ux-suggestion-marker';
                  marker.style.left = `${(s.x / imgNaturalWidth) * 100}%`;
                  marker.style.top = `${(s.y / imgNaturalHeight) * 100}%`;
                  marker.style.transform = 'translate(-50%, -50%)';
                  marker.title = s.suggestion;
                  marker.innerHTML = `<span>${idx + 1}</span>`;
                  marker.onclick = (e) => { e.stopPropagation(); alert(`Suggestion #${idx+1}: ${s.suggestion}`); };
                  container.appendChild(marker);
              });
          }
      });
      </script>
</body>
</html>
