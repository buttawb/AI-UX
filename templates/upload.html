<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI UX Tester</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #heatmapContainer {
        width: 500px;
        height: 500px;
        position: relative;
        border: 1px solid #ccc;
      }
      .file-selection {
        margin: 10px 0;
      }

      /* Add marker style */
      .ux-suggestion-marker {
        transition: box-shadow 0.2s;
        box-shadow: 0 0 8px #f00;
      }
      .ux-suggestion-marker:hover {
        box-shadow: 0 0 16px #f00;
      }
    </style>
  </head>
  <body>
    <h1>AI UX Tester</h1>

    <!-- Select Figma File (this is hardcoded for now) -->
    <div class="file-selection">
      <label for="figmaFileSelect">Figma File: </label>
      <span>Document-Upload-Scenarios</span>
      <!-- This is hardcoded for now -->
    </div>

    <!-- Submit Button -->
    <button id="submitBtn">Submit for Analysis</button>

    <!-- Display Heatmap -->
    <h2>Analyzing design: <span id="designName">ShopUnion</span></h2>

    <div style="display:flex; gap: 20px;">
      <!-- Left: Design + Heatmap container -->
      <div id="heatmapContainer" style="position: relative; width: 1300px; height: 600px; border: 1px solid #ccc;">
        <img id="figmaImage" src="" alt="Figma Design" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 0;">
        <div id="heatmapLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
      </div>
    
      <!-- Right: UX Report -->
    </div>
    <br>
    <br>

          <div id="uxReport" style="width: 1300px; max-height: 600px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; white-space: pre-wrap;"></div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

    <script>
      const FIGMA_FILE_ID = 'yS1jm9l3wX3ie4RwAJA01V'; // your file ID
      
      // Step 1: Fetch image URL from backend and set it
      function loadDesignImage() {
        return $.ajax({
          url: '/ux/fetch_figma_image_url/',
          type: 'GET',
        }).then(response => {
          if (response.image_url) {
            const $img = $('#figmaImage');
            $img.attr('src', response.image_url);
            // Wait for image to load, then set container and heatmapLayer size to match image
            return new Promise(resolve => {
              $img.on('load', function() {
                const naturalWidth = this.naturalWidth;
                const naturalHeight = this.naturalHeight;
                // Set heatmapContainer and heatmapLayer to match image size exactly
                $('#heatmapContainer').css({
                  width: naturalWidth + 'px',
                  height: naturalHeight + 'px'
                });
                $('#heatmapLayer').css({
                  width: naturalWidth + 'px',
                  height: naturalHeight + 'px'
                });
                resolve();
              });
              // If already loaded (cache), trigger manually
              if ($img[0].complete) $img.trigger('load');
            });
          }
        });
      }
      
      // Step 2: Fetch design JSON (or skip if you already have it), send to AI, get heatmap + report
      function analyzeDesignWithAI(figmaData) {
        return $.ajax({
          url: '/ux/generate_heatmap/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ figma_data: figmaData }),
        });
      }
      
      // Step 3: Render heatmap on overlay div
      function renderHeatmap(data) {
        if (!data || !Array.isArray(data)) {
          console.error('Invalid heatmap data received:', data);
          return;
        }

        const container = document.getElementById('heatmapLayer');
        if (window.heatmapInstance) {
          window.heatmapInstance.setData({ max: 0, data: [] });
          container.innerHTML = '';
        }
        window.heatmapInstance = h337.create({
          container: container,
          radius: 40,
          maxOpacity: 0.6,
          minOpacity: 0,
          blur: 0.75,
        });
    
        // heatmap.js expects 'value' key instead of 'intensity'
        const formattedData = data.map(pt => ({
          x: pt.x,
          y: pt.y,
          value: pt.intensity ?? 1,
        }));
    
        window.heatmapInstance.setData({
          max: 1,
          data: formattedData,
        });
      }

      // Step 3b: Render UX suggestions as markers on the image
      function renderSuggestions(suggestions) {
        const container = document.getElementById('heatmapLayer');
        const img = document.getElementById('figmaImage');
        // Remove old markers
        container.querySelectorAll('.ux-suggestion-marker').forEach(m => m.remove());
        if (!Array.isArray(suggestions) || !img.complete) return;

        // Use the actual image and container size (now always equal)
        const imgNaturalWidth = img.naturalWidth;
        const imgNaturalHeight = img.naturalHeight;
        const imgDisplayWidth = img.width;
        const imgDisplayHeight = img.height;

        suggestions.forEach((s, idx) => {
          // Map Figma coordinates (assuming they are relative to the natural image size)
          const x = (s.x / imgNaturalWidth) * imgDisplayWidth;
          const y = (s.y / imgNaturalHeight) * imgDisplayHeight;

          const marker = document.createElement('div');
          marker.className = 'ux-suggestion-marker';
          marker.style.position = 'absolute';
          marker.style.left = (x - 10) + 'px';
          marker.style.top = (y - 10) + 'px';
          marker.style.width = '20px';
          marker.style.height = '20px';
          marker.style.background = 'rgba(255,0,0,0.7)';
          marker.style.borderRadius = '50%';
          marker.style.display = 'flex';
          marker.style.alignItems = 'center';
          marker.style.justifyContent = 'center';
          marker.style.cursor = 'pointer';
          marker.style.zIndex = 2;
          marker.title = s.suggestion;
          marker.innerHTML = `<span style='color:#fff;font-size:12px;font-weight:bold;'>${idx+1}</span>`;
          marker.onclick = function(e) {
            e.stopPropagation();
            alert(s.suggestion);
          };
          container.appendChild(marker);
        });
      }
      
      // Step 4: Show UX report text
      function showUXReport(reportText) {
        $('#uxReport').text(reportText);
      }
      
      // Main submit flow
      $('#submitBtn').click(async function () {
        try {
          // 1. Load Figma image
          await loadDesignImage();
      
          // 2. Fetch full design JSON from backend
          const figmaResponse = await $.ajax({
            url: '/ux/fetch_figma_file/',
            type: 'POST',
            data: { file_id: FIGMA_FILE_ID },
          });
      
          // 3. Send design JSON to AI for heatmap + report + suggestions
          const aiResponse = await analyzeDesignWithAI(figmaResponse.document);
          
          // Log the response to debug
          console.log('AI Response:', aiResponse);
          
          if (!aiResponse || !aiResponse.heatmap_data || !aiResponse.heatmap_data.heatmap) {
            throw new Error('Invalid response from AI analysis');
          }
      
          // 4. Render heatmap
          renderHeatmap(aiResponse.heatmap_data.heatmap);

          // 4b. Render UX suggestions as markers
          if (aiResponse.heatmap_data.suggestions) {
            renderSuggestions(aiResponse.heatmap_data.suggestions);
          }
      
          // 5. Show detailed UX report
          showUXReport(aiResponse.heatmap_data.report);
      
          // 6. Show design name
          $('#designName').text(figmaResponse.name || 'Unknown Design');
        } catch (e) {
          console.error('Error:', e);
          alert('Failed to analyze design. Check console for details.');
        }
      });
    </script>
  </body>
</html>
