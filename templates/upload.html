<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI UX Tester - Multi-Frame Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI UX Tester</h1>
            <p>Transform your Figma designs into actionable UX insights with AI-powered analysis</p>
        </div>

        <div id="controls">
            <div class="form-group">
                <label for="figmaFileId">Figma File ID</label>
                <input type="text" id="figmaFileId" value="1J2MSZzASUTEKNrrQm5o8b" class="form-control" placeholder="Enter your Figma file ID">
                <small class="form-text">The unique identifier of your Figma file to analyze</small>
            </div>
            <div class="form-group">
                <label for="userPrompt">Custom Analysis Instructions</label>
                <textarea id="userPrompt" class="form-control" rows="4" placeholder="Add specific instructions for the analysis (e.g., focus on mobile responsiveness, accessibility, or specific user flows)"></textarea>
                <small class="form-text">Your instructions will guide the analysis while maintaining the required output structure</small>
            </div>
            <button id="submitBtn">Start Analysis</button>
        </div>

        <div id="loader">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">Analyzing your design... This may take a few minutes</p>
        </div>

        <div id="analysisContainer"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>

    <script>
      $(document).ready(function() {
          const $submitBtn = $('#submitBtn');
          const $loader = $('#loader');
          const $analysisContainer = $('#analysisContainer');
          const $loadingText = $('#loadingText');

          // Helper function to ensure minimum display time for loading messages
          async function updateLoadingText(text, minDisplayTime = 1500) {
              const startTime = Date.now();
              $loadingText.text(text);
              
              // Wait for the minimum display time
              const elapsedTime = Date.now() - startTime;
              if (elapsedTime < minDisplayTime) {
                  await new Promise(resolve => setTimeout(resolve, minDisplayTime - elapsedTime));
              }
          }
  
          $submitBtn.on('click', async function() {
              $submitBtn.prop('disabled', true);
              $loader.show();
              $analysisContainer.empty().hide();
  
              try {
                  // 1. Fetch the entire Figma file structure
                  console.log("Fetching Figma file structure...");
                  await updateLoadingText('Fetching Figma file structure...');
                  const figmaFileId = $('#figmaFileId').val();
                  const userPrompt = $('#userPrompt').val();
                  
                  const figmaFileResponse = await $.ajax({
                      url: '/ux/fetch_figma_file/',
                      type: 'GET',
                      data: { file_id: figmaFileId }
                  });
                  console.log("Figma file fetched.", figmaFileResponse);
  
                  // 2. Extract all top-level frames from the document
                  const frames = [];
                  figmaFileResponse.document.children.forEach(canvas => {
                      if (canvas.children) {
                          canvas.children.forEach(frame => {
                              if (frame.type === 'FRAME') {
                                  frames.push({
                                      id: frame.id,
                                      name: frame.name,
                                      node: frame
                                  });
                              }
                          });
                      }
                  });
  
                  if (frames.length === 0) {
                      throw new Error("No frames found in the Figma file.");
                  }
                  console.log(`Found ${frames.length} frames to analyze.`);
                  await updateLoadingText(`Found ${frames.length} frames to analyze...`);
                  const frameIds = frames.map(f => f.id);
  
                  // 3. Make parallel API calls
                  console.log("Fetching image URLs and running AI analysis in parallel...");
                  await updateLoadingText('Fetching image URLs and preparing for AI analysis...');
                  const [imageResponse, analysisResponse] = await Promise.all([
                      $.ajax({
                          url: '/ux/fetch_figma_image_urls/',
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify({ 
                              node_ids: frameIds,
                              file_id: figmaFileId 
                          }),
                      }),
                      $.ajax({
                          url: '/ux/generate_heatmap/',
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify({ 
                              figma_data: figmaFileResponse.document,
                              user_prompt: userPrompt 
                          }),
                      })
                  ]);
                  let heatmapData = analysisResponse.heatmap_data;
                  let analysisData;

                  await updateLoadingText('Processing AI analysis results...');
                  // *** DEBUGGING & FIX: Add robust checks and clear logging ***
                  console.log("Raw image response from server:", imageResponse);
                  console.log("Raw analysis response from server:", heatmapData);
  
                  if (!imageResponse || !imageResponse.image_urls) {
                      throw new Error("The server response for images was invalid or missing the 'image_urls' key.");
                  }
                  const imageUrls = imageResponse.image_urls;
  
                  if (heatmapData && !heatmapData.analysis_data) {
                      analysisData = heatmapData;
                      throw new Error("The server response for AI analysis was invalid or missing the 'analysis_data' key.");
                  }
                  else {
                    analysisData = heatmapData.analysis_data;
                  }
                  console.log("Data received and validated. Rendering results...");
                  await updateLoadingText('Rendering analysis results...');
                  $loader.hide();
  
                  // 4. Render results for each frame
                  frames.forEach(frame => {
                      const imageUrl = imageUrls[frame.id];
                      const frameAnalysis = analysisData[frame.id];
  
                      if (!imageUrl || !frameAnalysis) {
                          console.warn(`Skipping frame "${frame.name}" (${frame.id}) due to missing image URL or analysis data for this specific frame.`);
                          return; // Safely skip this frame
                      }
  
                      // Create the HTML structure for this frame
                      const safeId = frame.id.replace(/:/g, '-');
                      const uxScore = frameAnalysis.ux_score || 0;
                      
                      // Determine score category and emoji
                      let scoreClass = 'poor';
                      let scoreEmoji = '😢';
                      if (uxScore >= 90) {
                          scoreClass = 'excellent';
                          scoreEmoji = '🌟';
                      } else if (uxScore >= 75) {
                          scoreClass = 'good';
                          scoreEmoji = '👍';
                      } else if (uxScore >= 60) {
                          scoreClass = 'fair';
                          scoreEmoji = '🤔';
                      }
                      
                      const frameHtml = `
                          <div class="frame-container" id="frame-container-${safeId}">
                              <div class="frame-header">
                                  <span>${frame.name}</span>
                                  <div class="ux-score-container ${scoreClass}">
                                      <span>${scoreEmoji}</span>
                                      <span class="ux-score-value">${uxScore}</span>
                                      <span>UX Score</span>
                                  </div>
                              </div>
                              <div class="analysis-content">
                                  <div class="design-column">
                                      <div class="heatmap-container" id="heatmap-container-${safeId}">
                                          <img id="image-${safeId}" src="${imageUrl}" alt="Design for ${frame.name}" onerror="console.error('Image failed to load:', this.src)" />
                                          <div class="heatmap-layer" id="heatmap-layer-${safeId}"></div>
                                      </div>
                                  </div>
                                  <div class="report-column">
                                      <h2>UX/UI Report</h2>
                                      <div class="ux-report" id="report-${safeId}">${frameAnalysis.report}</div>
                                  </div>
                              </div>
                          </div>
                      `;
                      $analysisContainer.append(frameHtml);
  
                      console.log(`Setting up image load handler for frame ${frame.id} with URL:`, imageUrl);
                      
                      // Wait for the image to load before rendering heatmap/suggestions
                      const $image = $(`#image-${safeId}`);
                      console.log(`Looking for image with ID: image-${safeId}`);
                      console.log('Image element found:', $image.length > 0);
                      
                      $image.on('load', function() {
                          console.log(`Image load event triggered for frame ${frame.id}`);
                          const $image = $(this);
                          const imgNaturalWidth = $image[0].naturalWidth;
                          const imgNaturalHeight = $image[0].naturalHeight;
                          console.log(`Image loaded for frame ${frame.id}:`, {
                              naturalWidth: imgNaturalWidth,
                              naturalHeight: imgNaturalHeight,
                              src: $image.attr('src')
                          });

                          // Get the container's dimensions
                          const container = document.getElementById(`heatmap-container-${safeId}`);
                          const containerWidth = container.offsetWidth;
                          const containerHeight = container.offsetHeight;
                          console.log('Container dimensions:', { width: containerWidth, height: containerHeight });

                          // Calculate the scaling factor between Figma frame and actual image
                          const scaleX = imgNaturalWidth / frame.node.absoluteBoundingBox.width;
                          const scaleY = imgNaturalHeight / frame.node.absoluteBoundingBox.height;
                          console.log('Scaling factors:', { scaleX, scaleY });

                          renderHeatmap(frameAnalysis.heatmap, `heatmap-container-${safeId}`, imgNaturalWidth, imgNaturalHeight);
                          renderSuggestions(frameAnalysis, this, `heatmap-container-${safeId}`, imgNaturalWidth, imgNaturalHeight);
                      }).on('error', function(e) {
                          console.error(`Error loading image for frame ${frame.id}:`, e);
                      }).each(function() {
                          console.log(`Checking if image ${frame.id} is already complete:`, this.complete);
                          if (this.complete) {
                              console.log(`Image ${frame.id} is already loaded, triggering load event`);
                              $(this).trigger('load');
                          }
                      });
                  });
                  
                  $analysisContainer.show();
  
              } catch (error) {
                  console.error('An error occurred during the analysis process:', error);
                  const errorMessage = error.responseJSON ? JSON.stringify(error.responseJSON.error) : error.message;
                  $loader.hide(); // Ensure loader is hidden on error
                  $analysisContainer.html(`<p style="color:red; text-align:center;"><strong>Analysis Failed:</strong> ${errorMessage}</p>`).show();
              } finally {
                  $submitBtn.prop('disabled', false);
              }
          });
  
          function renderHeatmap(data, containerId, imgWidth, imgHeight) {
              console.log('Rendering heatmap with data:', data);
              console.log('Container ID:', containerId);
              
              if (!data || !Array.isArray(data)) {
                  console.warn('Invalid heatmap data:', data);
                  return;
              }
              
              const container = document.getElementById(containerId);
              if (!container) {
                  console.error('Container not found:', containerId);
                  return;
              }

              // Create heatmap instance with proper configuration
              const heatmapInstance = h337.create({
                  container: container,
                  radius: 40,
                  maxOpacity: 0.6,
                  minOpacity: 0,
                  blur: 0.75,
                  gradient: {
                      '.5': 'blue',
                      '.8': 'red',
                      '.95': 'white'
                  }
              });

              // Use coordinates directly as percentages
              const formattedData = data.map(pt => ({
                  x: pt.x,
                  y: pt.y,
                  value: pt.intensity || 1
              }));

              console.log('Heatmap data (using coordinates directly):', formattedData);

              // Set the data with proper max value
              heatmapInstance.setData({
                  max: 1,
                  data: formattedData
              });

              console.log('Heatmap rendered successfully');
          }
          
          function renderSuggestions(frameAnalysis, imgElement, containerId, imgWidth, imgHeight) {
              if (!frameAnalysis || !frameAnalysis.suggestions || !Array.isArray(frameAnalysis.suggestions)) return;
              const container = document.getElementById(containerId);
              if (!container) return;

              console.log('Rendering suggestions:', frameAnalysis.suggestions);

              // Create popup elements and append them to container instead of body
              const suggestionPopup = document.createElement('div');
              suggestionPopup.className = 'suggestion-popup';
              suggestionPopup.style.position = 'absolute';
              container.appendChild(suggestionPopup);

              const dropoffPopup = document.createElement('div');
              dropoffPopup.className = 'dropoff-popup';
              dropoffPopup.style.position = 'absolute';
              container.appendChild(dropoffPopup);

              let activeMarker = null;

              // Function to center popup over the image container
              function centerPopup(popup) {
                  const containerRect = container.getBoundingClientRect();
                  const popupRect = popup.getBoundingClientRect();
                  
                  // Calculate center position relative to the container
                  const top = (containerRect.height - popupRect.height) / 2;
                  const left = (containerRect.width - popupRect.width) / 2;
                  
                  popup.style.top = `${top}px`;
                  popup.style.left = `${left}px`;
              }

              // Render suggestion markers
              frameAnalysis.suggestions.forEach((s, idx) => {
                  const marker = document.createElement('div');
                  marker.className = 'ux-suggestion-marker';
                  
                  marker.style.left = `${s.x}%`;
                  marker.style.top = `${s.y}%`;
                  
                  marker.innerHTML = `<span>${idx + 1}</span>`;
                  
                  marker.onclick = (e) => { 
                      e.stopPropagation();
                      
                      // Toggle popup if clicking the same marker
                      if (activeMarker === marker) {
                          suggestionPopup.classList.remove('active');
                          activeMarker = null;
                          return;
                      }
                      
                      // Update popup content
                      suggestionPopup.innerHTML = `
                          <h3>Suggestion #${idx + 1}</h3>
                          <p>${s.suggestion}</p>
                      `;
                      
                      // Center popup over the image container
                      centerPopup(suggestionPopup);
                      
                      // Show popup
                      suggestionPopup.classList.add('active');
                      dropoffPopup.classList.remove('active');
                      activeMarker = marker;
                  };
                  
                  console.log('Adding suggestion marker at:', { x: s.x, y: s.y, suggestion: s.suggestion });
                  container.appendChild(marker);
              });

              // Render drop-off markers if they exist
              if (frameAnalysis && frameAnalysis.drop_off_points) {
                  console.log('Found drop-off points:', frameAnalysis.drop_off_points);
                  frameAnalysis.drop_off_points.forEach((d, idx) => {
                      const marker = document.createElement('div');
                      marker.className = 'ux-dropoff-marker';
                      
                      marker.style.left = `${d.x}%`;
                      marker.style.top = `${d.y}%`;
                      
                      marker.innerHTML = `<span>⚠️</span>`;
                      
                      marker.onclick = (e) => { 
                          e.stopPropagation();
                          
                          // Toggle popup if clicking the same marker
                          if (activeMarker === marker) {
                              dropoffPopup.classList.remove('active');
                              activeMarker = null;
                              return;
                          }
                          
                          // Update popup content
                          dropoffPopup.innerHTML = `
                              <h3>Drop-off Point #${idx + 1}</h3>
                              <p>${d.reason}</p>
                          `;
                          
                          // Center popup over the image container
                          centerPopup(dropoffPopup);
                          
                          // Show popup
                          dropoffPopup.classList.add('active');
                          suggestionPopup.classList.remove('active');
                          activeMarker = marker;
                      };
                      
                      console.log('Adding drop-off marker at:', { x: d.x, y: d.y, reason: d.reason });
                      container.appendChild(marker);
                  });
              } else {
                  console.log('No drop-off points found in frame analysis');
              }

              // Close popups when clicking outside
              document.addEventListener('click', (e) => {
                  if (!e.target.closest('.ux-suggestion-marker') && !e.target.closest('.ux-dropoff-marker')) {
                      suggestionPopup.classList.remove('active');
                      dropoffPopup.classList.remove('active');
                      activeMarker = null;
                  }
              });
          }
      });
      </script>
</body>
</html>
